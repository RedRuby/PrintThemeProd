{% if customer  %}

  {% assign Role_User = 'general.Role.User' | t %}
  {% assign Role_Printer = 'general.Role.Printer' | t %}
  {% assign Role_Manager = 'general.Role.Manager' | t %}
  {% assign Role_ASM = 'general.Role.ASM' | t %}
  {% assign Role_Admin = 'general.Role.Admin' | t %}

  {% assign region_NorthEast = "general.Region_Tags.NorthEast" | t %}
  {% assign region_SouthEast = "general.Region_Tags.SouthEast" | t %}
  {% assign region_California = "general.Region_Tags.California" | t %}
  {% assign region_South = "general.Region_Tags.South" | t %}
  {% assign region_Mountain = "general.Region_Tags.Mountain" | t %}
  {% assign region_MidAtlantic = "general.Region_Tags.MidAtlantic" | t %}
  {% assign region_MidWest = "general.Region_Tags.MidWest" | t %}
  {% assign region_GreatLakes = "general.Region_Tags.GreatLakes" | t %}
  {% assign region_External = "general.Region_Tags.External" | t %}

  {% if customer.tags contains region_NorthEast %}
    {% assign customer_region_tag = region_NorthEast %}
  {% elsif customer.tags contains region_SouthEast %}
    {% assign customer_region_tag = region_SouthEast %}
  {% elsif customer.tags contains region_California %}
    {% assign customer_region_tag = region_California %}
  {% elsif customer.tags contains region_South %}
    {% assign customer_region_tag = region_South %}
  {% elsif customer.tags contains region_Mountain %}
    {% assign customer_region_tag = region_Mountain %}
  {% elsif customer.tags contains region_MidAtlantic %}
    {% assign customer_region_tag = region_MidAtlantic %}
  {% elsif customer.tags contains region_MidWest %}
    {% assign customer_region_tag = region_MidWest %}
  {% elsif customer.tags contains region_GreatLakes %}
    {% assign customer_region_tag = region_GreatLakes %}
  {% endif %}

  {% if customer.tags contains Role_User %}
    {% assign customer_role_tag = Role_User %}
  {% elsif customer.tags contains Role_Manager %}
    {% assign customer_role_tag = Role_Manager %}
  {% elsif customer.tags contains Role_Printer %}
    {% assign customer_role_tag = Role_Printer %}
  {% elsif customer.tags contains Role_ASM %}
    {% assign customer_role_tag = Role_ASM %}
  {% elsif customer.tags contains Role_Admin %}
    {% assign customer_role_tag = Role_Admin %}
  {% endif %}

{% endif %}

<div class="section-header section-header--large printModeExclude">
  <h1 class="section-header__title">{{ 'customer.account.title' | t }}</h1>
</div>

<div class="grid printModeExclude">
  <div class="grid__item two-thirds">
    <div class="grid">
      <div class="grid__item one-third small--one-whole">
        <p><a id="account-back_btn" href="/account"><button type="button" class="btn btn--primary1"><i class="fa fa-caret-left"></i> {{ 'customer.account.return' | t }}</button></a></p>
      </div>
      <div class="grid__item  two-thirds small--one-whole text-right">
         {% if customer.tags contains Role_ASM %}
        	<button id="asm_orderEdit" type="button" class="btn btn--primary1" onclick="addToModal(order_id);" title="Edit this order">Edit</button>
        	<button id="asm_orderCancel" type="button" class="btn btn--primary1" onclick="showCancelModal();" title="Cancel this order">Cancel</button>
         {% endif %}
         <button id="printOrder" style="margin: 0 20px;" type="button" class="btn btn--primary1" onclick="windowPrint();" title="Print this order"><i class="fa fa-print"></i> Print this Order</button>
         <button id="prevOrderBtn" type="button" class="btn btn--primary1" onclick="eval(this.getAttribute('onclickf'));" title="previous order"><i class="fa fa-arrow-left"></i></button>
         <button id="nextOrderBtn" type="button" class="btn btn--primary1" onclick="eval(this.getAttribute('onclickf'));" title="next order"><i class="fa fa-arrow-right"></i></button>
      </div>
    </div>
  </div>
</div>

<br>

<div id="address-hidden" class="one-whole hide"></div>

<div id="id01" class="grid" style="display:none;">

  <div class="grid__item two-thirds medium-down--one-whole print-one-whole">
    <div id="id02" class="printModeExclude">
      <div class="grid">
        <div class="grid__item one-half small--one-whole">
          <h2 class="h3 order_name_h2" style="display:inline-block;"><b>Order #{% raw %}{{ order_name }}{% endraw %}</b></h2><p class="printModeExclude" style="display:inline-block;">, <b class="printModeExclude">Placed on :</b> {% raw %}{{ order_date }}{% endraw %}<span class="printModeInclude fulfillment_block2 hide" style="text-transform:capitalize;">, </span></p>  	
        </div>
         <div class="grid__item  one-half small--one-whole text-right">
           
        </div>
      </div>

      
      <div id="cancelled" class="errors" style="display:none;">
        <p class="h5">Cancelled at : {% raw %}{{ cancelled_at }}{% endraw %}</p>
        <p>Cancel Reason : {% raw %}{{ cancel_reason }}{% endraw %}</p>
      </div>
	</div>
    
    <div id="" class="table-wrap1">
      <table class="responsive-table w3-table w3-bordered w3-striped full1">
        <thead>
          <tr class="w3-text-white" style="background-color: {{ settings.color_topbar_bg }}">
            <th>{{ 'customer.order.product' | t }}</th>
            <th>{{ 'customer.order.sku' | t }}</th>
            <th class="text-right">{{ 'customer.order.price' | t }}</th>
            <th class="text-right">{{ 'customer.order.quantity' | t }}</th>
            <th class="text-right">{{ 'customer.order.total' | t }}</th>
          </tr>
        </thead>
        
        <tbody id="lineItem" style="position:relative;">
          
          <tr w3-repeat="line_items">
            <td>
              
              <div class="row">
                <div class="w3-col s4">
                  <img src="{{ 'ajax-loader.gif' |asset_url }}" srcs="{% raw %}{{ product_thumb_url }}{% endraw %}" style="max-width:90px; cursor:zoom-in;" class="js-toggle-previewImg-modal zoom-lightbox1" data-mfp-src="{% raw %}{{ product_image_url }}{% endraw %}">
                </div>
                <div class="w3-col s8">
                  {% raw %}{{ title }}{% endraw %}
                  <div id="properties_{% raw %}{{ line_item_No }}{% endraw %}" class="properties-wrapper">
                    <b>Properties:</b>
                    <div class="note">
                      <p w3-repeat="properties">{% raw %}{{ property_name }}{% endraw %} : {% raw %}{{ property_value }}{% endraw %}</p>
                    </div>
                  </div>
                </div>
              </div>
              
            </td>
            <td>{% raw %}{{ sku }}{% endraw %}</td>
            <td class="text-right">{% raw %}{{ price }}{% endraw %}</td>
            <td class="text-right">{% raw %}{{ quantity }}{% endraw %}</td>
            <td class="text-right">{% raw %}{{ total }}{% endraw %}</td>
          </tr>
          
        </tbody>
        
        <tbody id="discountCodes" style="display:none;">
          <tr w3-repeat="discount_codes" class="order_summary discount">
            <td colspan="4">{{ 'customer.order.discount' | t }} <b>{% raw %}{{ code }}{% endraw %}</b></td>
            <td class="text-right">-${% raw %}{{ amount }}{% endraw %}</td>
          </tr>
        </tbody>
        
        <tbody class="printModeExclude">  
          <tr id="subTotal">
            <td colspan="4">{{ 'customer.order.subtotal' | t }}</td>
            <td class="text-right">${% raw %}{{ sub_total }}{% endraw %}</td>
          </tr>
        </tbody>
        
        <tbody id="shippingPrice" style="display:none;">  
          <tr w3-repeat="shipping_lines">
            <td colspan="4">
              <div class="row">
                <div class="w3-col s4">
                  {{ 'customer.order.shipping' | t }} <b>{% raw %}({{ title }}){% endraw %}</b> <span id="trackNo-wrap" style="display:none;"> &nbsp;&nbsp;&nbsp;<b>Tracking No. : </b></span>
                </div>
                <div class="w3-col s8">
                  <span id="trackNo"></span>
                </div>
              </div>
            </td>
            <td class="text-right">${% raw %}{{ price }}{% endraw %}</td>
          </tr>
        </tbody>

        <tfoot>
          <tr id="taxPrice" style="display:none;">
            <td colspan="4">{{ 'customer.order.tax' | t }} ({{ tax_line.title }} {{ tax_line.rate | times: 100 }}%)</td>
            <td class="text-right">{{ tax_line.price | money }}</td>
          </tr>

          <tr id="grandTotal">
            <td colspan="4"><strong>{{ 'customer.order.total' | t }}</strong></td>
            <td class="text-right"><strong>${% raw %}{{ total }}{% endraw %} {{ order.currency }}</strong></td>
          </tr>
          
        </tfoot>
      </table>
      
      <div class="fulfilled" style="display:none;">
        <div class="note">
        Fulfillment created at: <span class="created_at"></span> and updated at: <span class="updated_at"></span>
        <br><a target="_blank" href=""></a>
        </div>
      </div>
      {% comment %}
      <div id="note" class="note"  style="display:none;">
        <b>Note : </b><span class="note_text"></span>
      </div>
      {% endcomment %}
      
      <div class="print-notes">
      {% if customer.tags contains Role_ASM or customer.tags contains Role_Printer or customer.tags contains Role_Admin %}
        {% include 'order-note-module' with customer_role_tag %}
      {% endif %}
      </div>
      
    </div>

  </div>

  <div id="address" class="grid__item one-third medium-down--one-whole">
    
	<div class="print-w3-half printModeExclude">
      <h2 class="h3"><b class="printModeExclude">{{ 'customer.order.billing_address' | t }}</b><b class="printModeInclude hide">Order By</b></h2>

  <!--     <p><strong>{{ 'customer.order.payment_status' | t }}:</strong> {% raw %}{{ payment_status }}{% endraw %}</p> -->

      <div id="billing_address">
      <span class="h5 name"></span>

      <p>
        <span class="email"></span>
        <span class="company printModeExclude"></span>

        <span class="address1 printModeExclude"></span>
        <span class="address2 printModeExclude"></span>

        <span class="city printModeExclude"></span>
        <span class="province printModeExclude"></span>

        <span class="zip printModeExclude"></span>
        <span class="country printModeExclude"></span>
        <span class="phone printModeExclude"></span>

      </p>
        
      <p class="fulfillment_block"><strong><span class="printModeExclude">Fulfillment</span> status:</strong> {% raw %}{{ fulfillment_status }}{% endraw %}</p>
      </div>
    </div>
    
    <div class="print-w3-half">
      <h2 class="h3 printModeExclude"><b>{{ 'customer.order.shipping_address' | t }}</b></h2>

      <div id="shipping_address">
        <span class="printModeExclude name"></span>

        <span class="email hide"></span>
        <span class="company"></span>
		<span class="addr">
          <span class="address1"></span>
          <span class="address2"></span>

          <span class="city"></span>
          <span class="province"></span>

          <span class="zip"></span>
          <span class="country printModeExclude"></span>
          <span class="phone printModeExclude"></span>
        </span>
      <p></p>
      </div>
    </div>
  </div>

  {% if customer.tags contains Role_ASM %}
   
   <div id="assign-printer-wrapper" class="grid__item one-third medium-down--one-whole print-shop-block printModeExclude">
    <label for="assign-printer">Assign Order to Vendor</label>
   	<select id="assign-printer" onchange="changePrintShop(this);">
     <option selected disabled>Select Vendor</option>
    </select>
   </div>
  {% elsif customer.tags contains Role_Printer %}
  <div  class="grid__item one-third medium-down--one-whole print-shop-block printModeExclude">
<!--     <input type="text" disabled readonly style="cursor:default;" value="" placeholder="Shipping Price Not Set" />
    <input type="text" disabled readonly style="cursor:default;" value="" placeholder="Tracking Company Not Set" />
    <input type="text" disabled readonly style="cursor:default;" value="" placeholder="Tracking Number Not Set" /> -->
    <div id="shipping_details">
      <label for="fulfillment">Cancel Fulfillment</label>
      <select id="fulfillment" onchange="if(this.value == 'unfulfilled'){ cancelFulfillment(); }">
          <option value="fulfilled">Fulfilled</option>
          <option value="unfulfilled">Unfulfilled</option>
      </select>
    </div>
    <button id="update-fulfillment" class="js-toggle-update-modal1 updateBtn btn" style="display:none; min-width:350px;" title="Update this order" status="" onclick="addToModal(this);" order_id="" >Update Fulfillment</button>
  </div>
  {% endif %}
  
</div>

{% if customer.tags contains Role_Printer %}
	<div class="mfp-wrapper">
      {% include 'magnificPopup-orderUpdate-Printer' %}
	</div>
    <style>
     .mfp-wrapper .mfp-content{width:50% !important;}
    </style>
{% elsif customer.tags contains Role_ASM %}
	<div id="mfp-order-edit" class="mfp-wrapper1">
      {% include 'magnificPopup-orderEdit-ASM' %}
    </div>
	<div id="mfp-order-cancel">
    {% include 'order-cancel-module' %}
    </div>
    <style>
      .mfp-content{width:60% !important;}
    </style>
{% endif %}

{{ 'youarei.js' | asset_url | script_tag }}

{% comment %}
{{ "https://cdnjs.cloudflare.com/ajax/libs/jspdf/0.9.0rc1/jspdf.min.js" | script_tag }}

{{ 'html2canvas.js' | asset_url | script_tag }}
{% endcomment %}

<script type="text/javascript">
  {% if customer.tags contains Role_Printer %}
  var printer_order = false;
  {% endif %}
  var url = document.URL;
  var order_id = '';
  var order_name = '';
  var order_data = [];
  var printer_id = '';
  var cemail = "{{ customer.email }}"
  var patt = new RegExp("id\=\\d+");
  var res = patt.test(url); //console.log(order_id);
  var btnState = null;
  var prev_page_params = (url.indexOf('&') != -1) ? '&'+url.substr(url.indexOf('&')+1, url.length-1) : ''; //url.split('&')[1]||'';
  
  var bemail = '';
  
//   $(document).ready(function(){
  	if(res){
       order_id = url.split('id\=')[1].split('&')[0];
       fetch_Order(order_id, true, null);
    }
    else window.location.assign('{{ shop.url }}/account');
//   });
  
  
  
//   var printer_values    = null;
//   var selectList = document.getElementById("assign-printer");    
//   var order_tags = null;

                              
                              
  function mfpInit(){
  	$('.js-toggle-previewImg-modal').magnificPopup({
        type: 'image',
        mainClass: 'mfp-fade1',
      	removalDelay: 500,
        closeOnBgClick: false,
        closeBtnInside: false,
        closeOnContentClick: false,
//         tClose: password.strings.pageClose,
        removalDelay: 500,
      	tLoading: '<i class="fa fa-refresh w3-spin w3-text-black"></i>',
      	preloader: true,
        callbacks: {
          beforeOpen: function() {
            this.st.image.markup = this.st.image.markup.replace('mfp-figure', 'mfp-figure mfp-with-anim');
                this.st.mainClass = 'mfp-zoom-out';
          },
          close: function(){
          }
        }
      });
  }
  
  function fetch_Order(order_ids, first, state, no_fulfillment, withATM){
    btnState = state;
    order_id = order_ids;
    
    $('.prop-hide-style').remove();
//     $('.properties-wrapper .note').html('<p w3-repeat="properties">{% raw %}{{ property_name }}{% endraw %} : {% raw %}{{ property_value }}{% endraw %}</p>');
    
//     freez();
//     var data = {order_id: order_ids, cemail: "{{ customer.email }}", ctoken: "{{ customer.id  | hmac_sha1: shop.domain }}" };
                
    {% comment %}{% endcomment %}
                
    {% include 'customer-account-common-code' with 'fetchOrders-code' %}

	if(no_fulfillment && data.fulfillment_status != undefined) prev_page_params = prev_page_params.replace('fulfillment_status=fulfilled','');
                
    data.order_id = order_ids;
                
  	 $.ajax({
          url: '/apps/pepsi-print/collection_response/get_order_detail.json',
          type: 'GET',
          data: data,
          dataType: 'json',
                success: function(data){
//             	console.log(JSON.stringify(data)); 
                if(data.status == 'ok' && data.order != undefined){
                  
                  order_data = data;
                  
                  {% if customer.tags contains Role_ASM %}
                  	if(withATM){
                        addToModal(data.order.id);
                    }
                  {% endif %}
                  
                  {% if customer.tags contains Role_Printer %}
                  if(data.order.printer_id == {{ customer.id }})
                      printer_order = true;
                  else{
                      show_message4('Order not assigned to you or Assignment has been cancelled.',false);
                      setTimeout(function(){ window.location.assign('/account'); }, 3000);
                  }
                  if(printer_order){% endif %}
                    $(document).ready(function(){
                      if(prev_page_params.length > 0)
                        $('#account-back_btn').attr('href', '/account?'+prev_page_params);
                      
                      History.Adapter.bind(window, 'statechange', function(){ console.log('state outside:', btnState);
                        if(btnState == null){ console.log('state inside:', btnState);
                          order_id = History.getState().url.split('id=')[1]||''; 
                          if(order_id.length > 0)
                            fetch_Order(order_id, null, false);
                          else{
                          	$(window).unbind('statechange');
                            window.reload();
                          }
                        }
                      });
//                       dataHide(data);
                      $.when(dataHide(data)).done($.when(createThumbImg(data)).done(showOrderData(data)));
                    });
                  
                  if(first == null){console.log('pushed:', order_id);
                    if(btnState == true)
                      History.pushState({ url: document.location.href }, document.title, "?id="+order_id+prev_page_params);
                    else
                      History.replaceState({ url: document.location.href }, document.title, "?id="+order_id+prev_page_params);
//                     dataHide(data);
                    $.when(dataHide(data)).done($.when(createThumbImg(data)).done(showOrderData(data)));
                    btnState = null;
                  }
  //                 data = createThumbImg(data);
                }else{
                  show_message4(data.message,false);
//                   setTimeout(function(){ window.location.assign('{{ shop.url }}/account'); }, 3000);
                }
                
                
          },
          error: function(){
            show_message4(data.message,false);
          }
          
	 });
  }
  
  function showOrderData(data){
    			order_name = data.order.order_name;            
    
                setTimeout(w3DisplayData("id02", data.order),100);
                setTimeout(w3DisplayData("address", data.order),200); 
                setTimeout(w3DisplayData("lineItem", data.order),400); 
                setTimeout(w3DisplayData("subTotal", data.order),500);
                setTimeout(w3DisplayData("grandTotal", data.order),600);
    			setTimeout(w3DisplayData("discountCodes", data.order),700);
                setTimeout(w3DisplayData("shippingPrice", data.order),800);
// 				setTimeout(w3DisplayData("shipping_address", data.order.shipping_address),750);
    
    			
    			data.order.line_items.forEach(showProperties);
    			
    			
                function showProperties(item, index){ //console.log(item['product_id']);
					setTimeout( w3DisplayData("properties_"+item['line_item_No'], item), 900+100*index);
                }
    			
    			$('#billing_address .name').text(data.order.billing_address.name);
    			if(data.order.customer.email != null){ $('#billing_address .email').html(data.order.customer.email); }
    			bemail = data.order.customer.email;
    			if(data.order.billing_address.company != null){ $('#billing_address .company').html(data.order.billing_address.company); }
                if(data.order.billing_address.address1){ $('#billing_address .address1').html('<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'+data.order.billing_address.address1); }
                if(data.order.billing_address.address2){ $('#billing_address .address2').text(', '+data.order.billing_address.address2); }
                if(data.order.billing_address.city){ $('#billing_address .city').html('<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'+data.order.billing_address.city); }
                if(data.order.billing_address.province){ $('#billing_address .province').text(', '+data.order.billing_address.province); }
                if(data.order.billing_address.zip){ $('#billing_address .zip').text(', '+data.order.billing_address.zip); }
                if(data.order.billing_address.country){ $('#billing_address .country').html('<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'+data.order.billing_address.country); }
                if(data.order.billing_address.phone){ $('#billing_address .phone').html('<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'+data.order.billing_address.phone); }
    			
    			var shipping_name = '';
    			if(data.order.shipping_address.first_name){shipping_name = data.order.shipping_address.first_name}
    			if(data.order.shipping_address.last_name){shipping_name = shipping_name +' '+data.order.shipping_address.last_name}
    			$('#shipping_address .name').html( shipping_name +'<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>');
                if(data.order.shipping_address.email != null){ $('#shipping_address .email').html(data.order.shipping_address.email); }
    			if(data.order.shipping_address.company != null && data.order.shipping_address.company.length > 0){ $('#shipping_address .company').html('<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'+data.order.shipping_address.company+'<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'); }else $('#shipping_address .company').hide();
                if(data.order.shipping_address.address1){ $('#shipping_address .address1').html(data.order.shipping_address.address1+'<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'); }
                if(data.order.shipping_address.address2){ $('#shipping_address .address2').html(data.order.shipping_address.address2+'<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'); }
                if(data.order.shipping_address.city){ $('#shipping_address .city').html(data.order.shipping_address.city+', '); }
                if(data.order.shipping_address.province != null){ $('#shipping_address .province').text(data.order.shipping_address.province); }
                if(data.order.shipping_address.zip){ $('#shipping_address .zip').html(' '+data.order.shipping_address.zip+'<span class="printModeExclude"><br></span>'); }
                if(data.order.shipping_address.country){ $('#shipping_address .country').html(data.order.shipping_address.country+'<span class="printModeExclude"><br></span><span class="printModeInclude hide">, </span>'); }
                if(data.order.shipping_address.phone){ $('#shipping_address .phone').html(data.order.shipping_address.phone); }
    
    			if(data.order.fulfillments[0] != null){
    				if(data.order.fulfillments[0].created_at){ $('.note .created_at').html(data.order.fulfillments[0].created_at); }
                	if(data.order.fulfillments[0].updated){ $('.note .updated_at').html(data.order.fulfillments[0].updated); }
					if(data.order.fulfillments[0].tracking_url){ $('#note a').attr('href',data.order.fulfillments[0].tracking_url); }else $('.note a').removeAttr('href');
    				if(data.order.fulfillments[0].tracking_company){ $('#note a').html(data.order.fulfillments[0].tracking_company); }
    				if(data.order.fulfillments[0].tracking_number){ $('#note a').html($('#note a').html()+' #'+data.order.fulfillments[0].tracking_number); }
    				if(data.order.fulfillments[0].status == 'success'){ $('.fulfilled').show(); }
                  	
                  try{
                  	tnos = (data.order.fulfillments[0].tracking_number).split(','); 
//                   	if(tnos.length > 1)
                    tnos.forEach(function(item, index){
                      tnos[index] = '<a style="display:block;" target="_blank" href="'+data.order.fulfillments[0].tracking_url.replace(data.order.fulfillments[0].tracking_number, item)+'">'+item+'</a>';
                    });
                  
                    $('#trackNo').html(tnos.join(''));
                  
//                   	$('#trackNo').html(' <a target="_blank" href="'+data.order.fulfillments[0].tracking_url+'">'+data.order.fulfillments[0].tracking_number+'</a>');
                  	$('#trackNo-wrap').show();
                  }catch(e){ e.message; }
    			}
    
                $('img[srcs]').each(function(index, item){
                  $(item).attr('src', $(item).attr('srcs'));
                });
    			
    			if(data.order.discount_codes[0] != null ){ $('#discountCodes').show(); }
    	
    			if(data.order.cancelled_at.length == 0) { $('#cancelled').hide(); $('#shipping_details').hide(); }
    			
    			if(data.order.cancelled_at.length > 0){ 
                  $('#cancelled').show(); $('#shipping_details').hide(); 
                }
    
    			if(Boolean(data.order.notes) {% if customer.tags contains Role_Manager or customer.tags contains Role_User %}&& false{% endif %}){ 
//                   $('#note .note_text').text(data.notes).show();
//                     console.log('note:', data.order.notes);
                    orderMsg = JSON.parse(data.order.notes.replace(/=>/g, ':'));
                  	if((orderMsg.order_msg != undefined && orderMsg.order_msg||'').length > 0)
                      $.when(prepareMsg(orderMsg, function(data){
                        w3DisplayData('orderNotes', data);
						
                      })).done(function(){ $('#orderNotes').show(0); });{% unless customer.tags contains Role_ASM or customer.tags contains Role_Printer %}
                    else
                      $('#orderBtn').hide(0);{% assign order_btn_hide = ', #orderBtn' %}{% endunless %}
                }else
                  $('#orderNotes, #orderNotes>div:nth-of-type(1) {{ order_btn_hide }}').hide(0), orderMsg = { "order_msg": []};
                  
    			if(data.order.shipping_lines != null ){ $('#shippingPrice').show(); }
    
                try{
                  if(data.order.previous_order_id){
                    $('#prevOrderBtn').attr('onclickf', 'fetch_Order("'+data.order.previous_order_id+'",null, false)').removeAttr('disabled');
                  }else
                    $('#prevOrderBtn').prop('disabled','disabled');
                  if(data.order.next_order_id){
                    $('#nextOrderBtn').attr('onclickf', 'fetch_Order("'+data.order.next_order_id+'",null, true)').removeAttr('disabled');
             	 }else
                    $('#nextOrderBtn').prop('disabled','disabled');
                }catch(e){ console.log(e.message); }    			
    
    			{% if customer.tags contains Role_ASM %}
                  printer_id = data.order.printer_id;
                  $.when(setTimeout(fetch_Printers(),800)).done(function(){
                    
                    if('fulfilled' == data.order.fulfillment_status){
                      $('#shippingPrice').show();
                      $('#asm_orderEdit, #asm_orderCancel').hide();
                      $('#assign-printer').prop('disabled','disabled').css('cursor','not-allowed').prop('title','Can\'t edit fulfilled Order.');
                    }else{
                      $('#shippingPrice').hide();
                      $('#asm_orderEdit, #asm_orderCancel').show();
                      $('#assign-printer').removeAttr('disabled').css('cursor','pointer').prop('title','');
                    }	
                    
                    if(data.order.cancelled_at.length > 0){ 
                      $('#assign-printer').prop('disabled','disabled').css('cursor','not-allowed').prop('title','Can\'t edit cancelled Order.');
                      $('#asm_orderEdit, #asm_orderCancel').hide();
                    }else{
                      if('fulfilled' != data.order.fulfillment_status){
                        $('#assign-printer').removeAttr('disabled').css('cursor','pointer').prop('title','');
                        $('#asm_orderEdit, #asm_orderCancel').show();
                      }
                    }
                    
                  });
    
    			{% elsif customer.tags contains Role_Printer %}
                  if('fulfilled' == data.order.fulfillment_status){
                    $('#fulfillment option:eq(0)').prop("selected", "selected").parent().removeAttr("disabled").show();
                    $('#update-fulfillment').hide();
                    $('#shipping_details').show();
                  }else{
                    $('#fulfillment option:eq(0)').prop("selected", "selected").parent().hide();
                    $('#update-fulfillment').attr('order_id', data.order.id).show();
                    $('#shipping_details').hide();
                  }
    
                  if(data.order.cancelled_at.length > 0){ 
                    $('#shipping_details, #update-fulfillment').hide();
//                     $('#fulfillment').prop('disabled','disabled').css('cursor','not-allowed');
                  }
    			{% endif %}
    
    			mfpInit();			
    
            	$.unblockUI(); 
    
    			order_data = data;
    
    			$('#id01').show(); 
  }
  
  {% if customer.tags contains Role_ASM %}
  function fetch_Printers(){
      $('#assign-printer, #select_vendor_edit').append('<option w3-repeat="results" value="{% raw %}{{id}}{% endraw %}" title="{% raw %}{{email}}{% endraw %}" select="{% raw %}{{selected}}{% endraw %}">{% raw %}{{company}}{% endraw %}</option>');
      $.ajax({
          url: '/apps/pepsi-print/printer_configuration/region_printers',
          type: 'GET',
          data: { cemail: "{{ customer.email }}", ctoken: "{{ customer.id  | hmac_sha1: shop.domain }}" },
          dataType: 'json',
          success: function (data) { //console.log(JSON.stringify(data));
                          data1 = popCompany(data,$('#assign-printer').attr('printer_id'));
                          w3DisplayData('assign-printer', data1);
                          w3DisplayData('select_vendor_edit', data1);
            
          }

      }).promise()
      	.done(function(){ 
          $('option[select = "selected"]').prop("selected", "selected"); 
          if('fulfilled' == order_data.order.fulfillment_status){
            $('#shippingPrice').show();
            $('#asm_orderEdit, #asm_orderCancel').hide();
            $('#assign-printer').prop('disabled','disabled').css('cursor','not-allowed').prop('title','Can\'t edit fulfilled Order.');
          }else{
            $('#shippingPrice').hide();
            $('#asm_orderEdit, #asm_orderCancel').show();
            $('#assign-printer').removeAttr('disabled').css('cursor','pointer').prop('title','');
          }
        
          if(order_data.order.cancelled_at.length > 0){ 
            $('#assign-printer').prop('disabled','disabled').css('cursor','not-allowed').prop('title','Can\'t edit cancelled Order.');
            $('#asm_orderEdit, #asm_orderCancel').hide();
          }else{
            if('fulfilled' != order_data.order.fulfillment_status){ console.log('');
              $('#assign-printer').removeAttr('disabled').css('cursor','pointer').prop('title','');
              $('#asm_orderEdit, #asm_orderCancel').show();
            }
          }
      });
  }
  
  function changePrintShop(obj){
      freez();
      var $this = $(obj); console.log($this.attr('order_id')+" changed to"+$this.val());
      var confirmed = true;
      if($(obj).find('option[select = "selected"]').length > 0){
         var existingPrinter = $(obj).find('option[select = "selected"]').text();
         if(confirm("Order is already assigned to a vendor '"+ existingPrinter +"'. \nDo you want to reassign it to '"+ $this.find('option[value="'+$this.val()+'"]').text() +"' ?") != true){
           $(obj).find('option[select = "selected"]').prop('selected', 'selected');
           confirmed = false;
         }
      }
      if(confirmed){
      {% comment %}alert('reassigned');{% endcomment %}
        $.ajax({
              url: '/apps/pepsi-print/printer_configuration/assign_print_to_order',
              type: 'POST',
              data: { cemail: "{{ customer.email }}", ctoken: "{{ customer.id  | hmac_sha1: shop.domain }}", order: order_id, printer_id: $this.val(), cregion: '{{ customer_region_tag |replace:'Region:','' |replace:'0','o'}}' },
              dataType: 'json',
              success: function(){$.unblockUI; show_message2('Assigned Successfully.',true); changed = true; },
              error: function(){$.unblockUI; show_message2('Some Error Occured.',false);}
        });
      }
   }
  
  function popCompany(data,val){
  	var i; //console.log(val+" printer_id");
    var x;
    var str;
    var total = 0;
    var myArray = data["results"]; //console.log(JSON.stringify(filter_obj)); console.log(myArray);
    for (i = 0; i < myArray.length; i++) {
//         str = myArray[i]["default_address"]["company"];
//       	if(str.length == 0){str = 'Company';}
//         myArray[i]["company_name"] = str;
      if(printer_id == myArray[i]["id"]){data["results"][i]["selected"] = "selected";} 
      else {data["results"][i]["selected"] = "none";} console.log('pI = '+ printer_id);
    } 
//     console.log(JSON.stringify(data));
    return(data);
  }
  
  var $oem = $('#OrderEditModal');
  
  function addToModal(obj){
        order_id = obj;
    //     freez();
        $('html').css('overflow','hidden');
    	$('#mfp-order-edit .mfp-bg, #mfp-order-edit .mfp-wrap').show().removeClass('mfp-hide');

    	data = order_data;
        console.log(JSON.stringify(data));
        
        w3DisplayData("lineItem2", data.order);
        $('#OrderEditModal form').attr('order_id', data.order.id);
        $('#OrderEditModal .orderName').text(data.order.order_name);
    //                 $('#OrderEditModal .subTotal').text(data.order.sub_total);
        $('#OrderEditModal .grandTotal').text(data.order.total);

    //                 $('#OrderEditModal .discountCode').val(data.order.discount_codes[0].code);
    //                 switch(data.order.discount_codes[0].type){
    //                 	case 'fixed_amount':
    //                 	case 'percentage':
    //                 	case 'shipping':
    //                	}
    //                 $('#OrderEditModal .discountType').text(data.order.sub_total);
    //                 $('#OrderEditModal .discountAmount').val(data.order.discount_codes[0].amount);
        {% comment %}
        if(Boolean(data.order.notes)){ 
    //                   $('#note .note_text').text(data.notes).show();
    //                     console.log('note:', data.order.notes);
            orderMsg = JSON.parse(data.order.notes.replace(/=>/g, ':'));
            if((orderMsg.order_msg||'').length > 0)
              $.when(prepareMsg(orderMsg, function(data){
                w3DisplayData('orderNotes', data);

              })).done(function(){ $('#orderNotes').show(0); });{% unless customer.tags contains Role_ASM or customer.tags contains Role_Printer %}
            else{
              $('#orderBtn').hide(0);
            }{% endunless %}
        }else
          $('#orderNotes').hide(0);
        {% endcomment %}
    //                 console.log('printer:', data.order.printer_id);
    //   				console.log('line_items:', data.order.line_items.length);
        if(data.order.printer_id != null || data.order.line_items.length == 0 ){
          $('.for-order-split').remove();
          $('td[colspan="3"]').attr('colspan', '2');
        }


        $.unblockUI(); $('.mfp-preloader').hide(); if($('.mfp-note').length == 0)$('.mfp-container').css('height','auto').prepend('<div class="mfp-note"><div class="note text-center" style="margin:0px 5%;"><p><b>Use the edit order function to adjust pricing, adjust quantities, and/or split an order.<b></p></div><br><div>'); $('#OrderEditModal').show().removeClass('mfp-hide');

          
  
  }

  {% elsif customer.tags contains Role_Printer %}
  
  function addToModal(obj){
    $('html').css('overflow','hidden');
    $('.mfp-wrapper .mfp-bg, .mfp-wrapper .mfp-wrap').show().removeClass('mfp-hide');
    var data = order_data;
    
    $('#OrderEditModal form').attr('order_id', data.order.id);
    $('#OrderEditModal .orderName').text(data.order.order_name);
    if(data.order.fulfillments[0]){
      $('#OrderEditModal .shipping_price').val(data.order.shipping_lines[0].price);
      $('#OrderEditModal .shipping_code').val(data.order.fulfillments[0].shipping_code);
      $('#OrderEditModal .tracking_company option[value = "'+data.order.fulfillments[0].tracking_company+'"]').prop('selected','selected');
      if(data.order.fulfillments[0].tracking_company.indexOf('Pick Up') != -1 || data.order.fulfillments[0].tracking_company == 'Install'  || data.order.fulfillments[0].tracking_company == 'Emailed (artwork only)'){ 
        $('#OrderEditModal .tracking_number').prop({'disabled':'disabled', 'value':''}).css('cursor', 'not-allowed'); 
        changeTracking(true);
      }else{ 
        $('#OrderEditModal .tracking_number').val(data.order.fulfillments[0].tracking_number); 
        changeTracking(false);
      }
      $('#OrderEditModal .tracking_url').val(data.order.fulfillments[0].tracking_url);
    }

    $.unblockUI(); $('.mfp-preloader').hide(); $('#OrderEditModal').show().removeClass('mfp-hide');
    
  }
	
  function cancelFulfillment(){
    var $this =$(this);
    freez();
    var data = { cemail: "{{ customer.email }}", ctoken: "{{ customer.id  | hmac_sha1: shop.domain }}", order_id: order_id };
  	$.ajax({
            url: '/apps/pepsi-print/order_configuration/cancel_fulfillment.json',
            type: 'POST',
            data: JSON.stringify(data),
            dataType: 'json',
           	contentType: 'application/json',
            success: function(){ $this.prop("disabled", "disabled").css('cursor','not-allowed'); $.unblockUI; show_message2('Updated Successfully.', true); setTimeout(fetch_Order(order_id, null, null, true), 1000);}, //location.reload()
            error: function(){$.unblockUI; show_message2('Some Error Occured.',false);}
    });
  }
  
  {% endif %}
  
  function createThumbImg(data){ console.log('thumb_called');
  	var i; 
    var img_url;
    var lastIndex;
    var myArray = data['order']['line_items'];
    for (i = 0; i < myArray.length; i++) {

      img_url = data['order']['line_items'][i]["product_image_url"];
      if(img_url != null){
        lastIndex = img_url.lastIndexOf('.');
        data['order']['line_items'][i]["product_thumb_url"] = img_url.substr(0, lastIndex)+'_150x'+img_url.substr(lastIndex);
      }else
        data['order']['line_items'][i]["product_thumb_url"] = 'http://placeholdit.imgix.net/~text?txtsize=35&bg=ddd&txtclr=aaa&txt=No%20Image&w=150&h=200&txttrack=0';
    } 
//     console.log(JSON.stringify(data));
//     return(data);
//        showOrderData(data);
  }

  function dataHide(data){
  	var i; 
    var x;
    var str;
    var total = 0;
    var file_name = '';
    var anchorPre = '';
    var anchorPost = '';
    var nullCount = 0;
    var myArray = data.order.line_items;  //console.log(JSON.stringify(myArray));
    for (i = 0; i < myArray.length; i++) {
      str = myArray[i]["title"].replace().replace(' / Default','').replace(' / {{ customer_region_tag }}','');
      myArray[i]["title"] = str;
      myArray[i]["line_item_No"] = i;
//       data['order']['properties_'+myArray[i]['product_id']] = myArray[i]['properties'];
      myArray2 = myArray[i]['properties']; nullCount = 0; //console.log(JSON.stringify(myArray2));
      if((myArray[i]['properties'] || '').length == 0)
      	 $('head').append('<style class="prop-hide-style">#properties_'+myArray[i]['line_item_No']+'{ display:none; }</style>'); 
      else{
        for (x = 0; x < myArray2.length; x++) { //console.log(JSON.stringify(myArray2[x]));
          try{
            myArray2[x]['property_value'] = myArray2[x]['property_value'].replace("'","\'");
          }catch(e){ console.log(myArray2[x]['property_name']); console.log(e.message); }
          if((myArray2[x]['property_value'] || '').length == 0 || myArray2[x]['property_name'] == 'Parent ID'){
  //         	delete myArray2[x]; 
              $('head').append('<style class="prop-hide-style">#properties_'+myArray[i]['line_item_No']+' p:nth-of-type('+(x+1)+'){ display:none; }</style>');
              nullCount++;
          }
          else if(myArray2[x]['property_name'].indexOf("_") != -1 && myArray2[x]['property_value'].indexOf(".") != -1){
              file_name = myArray2[x]['property_value'];
  //           	delete myArray2[x];	
              $('head').append('<style class="prop-hide-style">#properties_'+myArray[i]['line_item_No'] +' p:nth-of-type('+(x+1)+'){ display:none; }</style>');
              nullCount++;
          }
          else if(myArray2[x]['property_value'].indexOf("/uploads/") != -1 && myArray2[x]['property_value'].indexOf("&nbsp;") == -1){ console.log(myArray2[x]['property_value']);
            if(myArray2[x]['property_value'].toLowerCase().indexOf(".jpg") != -1 ||
               myArray2[x]['property_value'].toLowerCase().indexOf(".jpeg") != -1 ||
               myArray2[x]['property_value'].toLowerCase().indexOf(".png") != -1 ||
               myArray2[x]['property_value'].toLowerCase().indexOf(".gif") != -1 ){
              file_url = myArray2[x]["property_value"];
              anchorPre = "<a class='js-toggle-previewImg-modal zoom-lightbox1' title='View' href='"+file_url+"' data-mfp-src='"+file_url+"'>"
              anchorPost = "</a> &nbsp; <a target='_blank' title='Download' href='"+myArray2[x]["property_value"]+"'><i class='fa fa-download'></i></a>"
              myArray2[x]['property_value'] = anchorPre + file_name + anchorPost;
            }else{
              anchorPre = "<a target='_blank' href='"+myArray2[x]["property_value"]+"'>"
              anchorPost = "</a>"
              myArray2[x]['property_value'] = anchorPre + file_name + anchorPost;
            }
          }
        } if(myArray[i]['properties'].length == nullCount){ $('head').append('<style class="prop-hide-style">#properties_'+myArray[i]['line_item_No']+'{ display:none; }</style>'); }
        //else{ $('head').append('<style>#properties_'+myArray[i]['line_item_No']+' p:nth-last-child(1){ display:none; }</style>'); }
      }
    } 
//     data = removeEmpty(data);
//     console.log(JSON.stringify(data));
//     return(data);
//     $.when(createThumbImg(data)).done(showOrderData(data));
//     createThumbImg(data);
  }
  
  function removeEmpty(obj) {
    Object.keys(obj).forEach(function(key) {
      if (obj[key] && typeof obj[key] === 'object') removeEmpty(obj[key])
      else if (obj[key] == null) delete obj[key]
    });
    return obj;
  };
  
  
  {% comment %}
  var doc = new jsPDF();
  var specialElementHandlers = {
      '#editor': function (element, renderer) {
          return true;
      }
  };
  
  var element = $('#id01 .grid__item'); // global variable
  var getCanvas; // global variable
 
 function html2Img() { 
   	   $(".printModeExclude").hide();		
   
       html2canvas(element, {
         onrendered: function (canvas) {
//              imgURL = canvas.toDataURL("image/png");
           data = canvas.toDataURL('image/jpeg'); //.slice('data:image/jpeg;base64,'.length);
           // Convert the data to binary form
           printOrder2PDF(data); //atob(data));
//            console.log(data);
         },
         useCORS: true,
         onclone: function(doc){
			$(".printModeExclude").show();
           
          }
       });

  }
  
  function printOrder2PDF(imgData){
    doc.setFont('helvetica');
//   	doc.fromHTML($('#id01 .grid__item').html(), 15, 15, {
//         'width': 500,
//             'elementHandlers': specialElementHandlers
//     });
    doc.addImage(imgData, 'JPEG', 0, 10,200, 200);
    var date = new Date();
    doc.save(order_name+'-print-at-'+date.getTime()+'.pdf');
  }
  {% endcomment %}
  
  function toggleOrderBtns(){
  
  }
  
  function windowPrint(){
    $.when( 
      $('{% unless customer.tags contains Role_Printer %}header .grid--full:not(:nth-of-type(1)),{% endunless %} .header-bar, .printModeExclude:visible, footer').hide().toggleClass('visible'),
      $('.site-header__logo img').css('margin','0 0'),
      $('.site-header__logo').toggleClass('w3-col s4').after('<div class="w3-col s4 w3-padding-left after_logo_div" style="height:'+'px;"><p><b>Order #:</b> '+order_data.order.order_name+'</p></div>'
        +'<div class="w3-col s4 w3-padding-left after_logo_div" style="height:'+'px;"><p><b>Order Date:</b> '+order_data.order.order_date.split('{{ 'now' | date: "%Y" }}')[0]+' {{ 'now' | date: "%Y" }}'+'</p></div>'
        +'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Order By:</b> '+order_data.order.billing_address.name+'</p></div>'
        {% if customer.tags contains Role_ASM %}
        +'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Vendor:</b> '+ (($('#assign-printer option:selected').text() == 'Select Vendor') ? 'Not Assigned' : $('#assign-printer option:selected').text()) +'</p></div>'
      	+'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Attn to:</b> '+order_data.order.shipping_address.name+'</p></div>'
        {% else %}
      	+'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Order Status:</b> ' + ((order_data.order.cancelled_at.length > 0) ? 'Cancelled' : order_data.order.fulfillment_status )+'</p></div>'
      	+'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Attn to:</b> '+order_data.order.shipping_address.name+'</p></div>'
      	{% endif %}
      	{% if customer.tags contains Role_ASM %}
      	+'<div class="w3-col s4 w3-padding-left after_logo_div">&nbsp;</div>'
      	+'<div class="w3-col s4 w3-padding-left after_logo_div"><p><b>Order Status:</b> ' + ((order_data.order.cancelled_at.length > 0) ? 'Cancelled' : order_data.order.fulfillment_status )+'</p></div>'
      	{% endif %}
        +'<div class="w3-col s12 w3-padding-left after_logo_div"><span class="w3-margin-0"><b>Ship to:</b> <div style="display:inline-block;"'+ $('#shipping_address .addr').html() +'</div></span></div>'
      ),                                                     
        
      {% comment %}
//       $('.after_logo_div').html($('.order_name_h2').parent().html()+'<br/><h4 style="display:inline-block;">Order by: </h4> <span>'+$('#billing_address .name').text()+'</span>{% if customer.tags contains Role_ASM %} | <h4 style="display:inline-block;">Order Vendor: </h4> <span>' + (($('#assign-printer option:selected').text() == 'Select Vendor') ? 'Not Assigned' : $('#assign-printer option:selected').text()) +'</span>{% endif %}' ),
//       $('.after_logo_div').append('<br><h4>Order by: </h4>'+$('#billing_address .name').text()+', '+$('#billing_address .email').text()+' | <h4>Order Vendor: </h4>'+($('#assign-printer option:selected').text() == 'Select Vendor') ? 'Not Assigned' : $('#assign-printer option:selected').text() ),
//       $('.fulfillment_block2').html(' | '+$('.fulfillment_block').html()),
      {% endcomment %}

      $('#address-hidden, #id01').css({ 'position':'relative', 'bottom':'80px'}),
//       $('#id01, #id02').find('.grid__item:nth-of-type(1)').toggleClass('w3-padding-0').first().css('margin','0'),
      $('.printModeInclude').toggleClass('hide'),
      $('.print-one-whole').toggleClass('w3-right one-whole two-thirds'),
      $('#address').toggleClass('hide')
//       $('#address-hidden').html($('#address').html()).toggleClass('hide') //.find('.print-w3-half').toggleClass('grid__item one-half w3-padding-0')
    ).done(function(){ 
    	setTimeout(window.print(), 10);
    });
    
    {% comment %}{% endcomment %}
    $('{% unless customer.tags contains Role_Printer %}header .grid--full:not(:nth-of-type(1)),{% endunless %} .header-bar, .printModeExclude.visible, footer').show().toggleClass('visible');
    $('.site-header__logo img').css('margin','0 auto');
    $('.site-header__logo').toggleClass('w3-col s3');
    $('.after_logo_div').remove();
    $('#address-hidden, #id01').css({'position':'', 'bottom':''});
    
//     $('#id01, #id02').find('.grid__item:nth-of-type(1)').toggleClass('w3-padding-0').first().css('margin','');
    $('.printModeInclude').toggleClass('hide');
    $('.print-one-whole').toggleClass('w3-right one-whole two-thirds');
    $('#address').toggleClass('hide');
//     $('#address-hidden').html('').toggleClass('hide').find('.print-w3-half').toggleClass('grid__item one-half w3-padding-0')
    
  }
</script> 

<style>
@media print{
   /* applied to our table */
  .w3-table1, tr, td{ position: relative !important; }
   .w3-table tr td {
     -webkit-region-break-inside: avoid !important;
     page-break-inside:avoid !important;
     page-break-after: always;
  }
}

@media  print {
    thead, tbody, tfooter { 
        display: table-row-group;
    }
}
</style>