{% include 'customer-account-common-code' with 'theme-layout-code' %}

{% if cart.items.size > max_allowed_item_count %}
  {% layout 'none' %}
  <meta content="0; url=/cart" http-equiv="refresh" />
  {% continue %}
{% endif %}

<!-- <script
        src="https://code.jquery.com/jquery-3.1.0.slim.min.js"
        integrity="sha256-cRpWjoSOw5KcyIOaZNo4i6fZ9tKPhYYb6i5T9RSVJG8="
        crossorigin="anonymous">
</script> -->

<!-- {{ '//ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js' | script_tag }} -->

<!-- {{ 'jquery.mousewheel-3.0.6.pack.js' | asset_url | script_tag }} -->

<script type="text/java script">
 var $= jquery.noConflict();
</script>

<!-- {{ 'jquery.fancybox.css' | asset_url | stylesheet_tag }}
{{ 'jquery.fancybox.pack.js' | asset_url | script_tag }} -->

<style>
  body{overflow-Y:auto;}
  .page-width{max-width:auto;}
  .main-content{margin-top:0px;margin-bottom:10px;}
  .mfp-wrap {overflow: hidden !important;}
  .mfp-bg {background: rgba(0,0,0,0.5) !important;}
</style>

<center> <img id="loader" src="https://cdn.shopify.com/s/files/1/1634/5803/files/ezgif-2-d4611ba3b8.gif?9462985359619422407" style="width: 150px"> </center>

<a href="javascript:;" class="js-toggle-preview-modal" id="sample"></a> <!-- here we set a decoy link for the frame to be triggered-->

<div class="hide">

</div>

<iframe id="my_iframe" src="{{ page.content }}?cid={{customer.id}}&cregion={{customer_region_tag}}" frameborder="0" scrolling="no" allowtransparency="true" style="position: static; left: 0px; right: 0px; width: 100%;  height: 0px; border: none; margin:;" onload="resizeIframe(this)">
    Your browser doesn't support iframes
</iframe>

<script language="javascript" type="text/javascript">

  appFrameHeight = '';

  scrollTop = "";

  iframeObj = document.getElementById('my_iframe');

  iframeWin = getIframeWindow(iframeObj);

  iframeWinDoc = iframeWin.document;

  var _config = {

      // What you might want to change
      addToCartBtnLabel:             'Add to cart',
      addedToCartBtnLabel:           'Added',
      addingToCartBtnLabel:          'Adding...',
      soldOutBtnLabel:               'Sold Out',
      howLongTillBtnReturnsToNormal: 1000, // in milliseconds.
      cartCountSelector:             '.header-bar__cart-count',
      cartTotalSelector:             '#CartCost',
      // 'aboveForm' for top of add to cart form,
      // 'belowForm' for below the add to cart form, and
      // 'nextButton' for next to add to cart button.
  //     feedbackPosition:              'aboveForm',

      // What you will never need to change
      addToCartBtnSelector:          '#AddToCart',
      addToCartFormSelector:         'form[action="/cart/add"]',
      shopifyAjaxAddURL:             '/cart/add.js',
      shopifyAjaxCartURL:            '/cart.js'
    };

  $(window).scroll(function() {
    appFrameHeight = iframeWinDoc.body.scrollHeight+170+ 'px';
    iframeObj.style.height = appFrameHeight;
  });

  $(window).resize(function() {
    grid = $(iframeWinDoc).find('.row-height');
    if(grid.length)
      if(hasScroll($(iframeWinDoc).find('#price-list')[0], 'horizontal'))
        $(iframeWinDoc).find('#datatable-wrapper').css('margin-bottom', (getScrollbarWidth()+15)+'px');
  });

  function getIframeWindow(iframe_object) {
    var doc;

    if (iframe_object.contentWindow) {
      return iframe_object.contentWindow;
    }

    if (iframe_object.window) {
      return iframe_object.window;
    } 

    if (!doc && iframe_object.contentDocument) {
      doc = iframe_object.contentDocument;
    } 

    if (!doc && iframe_object.document) {
      doc = iframe_object.document;
    }

    if (doc && doc.defaultView) {
     return doc.defaultView;
    }

    if (doc && doc.parentWindow) {
      return doc.parentWindow;
    }

    return undefined;
  }

  function hasScroll(el, direction) {
    direction = (direction === 'vertical') ? 'scrollTop' : 'scrollLeft';
    var result = !! el[direction];

    if (!result) {
        el[direction] = 1;
        result = !!el[direction];
        el[direction] = 0;
    }
    return result;
  }
  
  function getScrollbarWidth() { 
    var div = $('<div style="width:50px;height:50px;overflow:hidden;position:absolute;top:-200px;left:-200px;"><div style="height:100px;"></div>'); 
    $(iframeWinDoc).find('body').append(div); 
    var w1 = $('div', div).innerWidth(); 
    div.css('overflow-y', 'scroll'); 
    var w2 = $('div', div).innerWidth(); 
    $(div).remove(); 
    return (w1 - w2); 
  }

  function resizeIframe(objr) {defreez();
    iframeWinDoc = getIframeWindow(objr).document;
    $(window).scrollTop(0);
    if(iframeWinDoc.getElementsByClassName('blockUI').length > 0){
      $("#loader").removeClass('hide');console.log('yes');
      objr.style.height = '0px';
    }else{
    $("#loader").addClass('hide');
    appFrameHeight = iframeWinDoc.body.scrollHeight+170+ 'px';
    objr.style.height = appFrameHeight;
    }
    updateCart();
    
    $(iframeWinDoc).find('[action="/apps/place_bulk_order?cid={{ customer.id }}"]').off('submit').on('submit', function(e){
      if($(iframeWinDoc).find('.distributor.checkbox:checked').length == 0){
        e.preventDefault();
        show_message2('Atleast one location required.',false, true);
        return false;
      }
    }).end().find('[href="/apps/place_bulk_order?action_type=list-location&cid={{ customer.id }}"]').attr('href',"/apps/place_bulk_order?action_type=list-location&cid={{ customer.id }}&cregion={{ customer_region_tag }}");

    grid = $(iframeWinDoc).find('.row-height').css('position', 'relative').find('.col-height').first().css({'position': 'absolute', 'width': '50%'}).end().find('.table-responsive').css('border', 'none').find('tr.fixed-td td.ellipses').removeClass('ellipses');
  
    if(grid.length)
      if(hasScroll($(iframeWinDoc).find('#price-list')[0], 'horizontal'))
        $(iframeWinDoc).find('#datatable-wrapper').css('margin-bottom', (getScrollbarWidth()+15)+'px');
                                            
//     fobj = iframeWinDoc.getElementById('fancybox-wrap');
//     alert(fobj.innerHTML);
//     setTimeout(function(){ resizeIframe(obj); }, 3000);
    iframeWin.onbeforeunload = function() {
      freez();
    };
  }
                                            


//   setInterval(function(){
//     fobj = obj.contentWindow.document.getElementById('fancybox-wrap');
//     if(fobj != null){
//       if(fobj.style.display == 'block') {compress(obj);}
//       else resizeIframe(obj);
//     }
//   }, 3000);

  $(document).ready(function(){
    $('#MainContent .page-width').removeClass('page-width');
//     $('.grid div').last().prop('id','vertical-ali');

    $('.js-toggle-preview-modal').magnificPopup({
        type: 'iframe',
        mainClass: 'mfp-fade',
        closeOnBgClick: false,
        closeBtnInside: false,
        closeOnContentClick: false,
//         tClose: password.strings.pageClose,
        removalDelay: 500,
        tLoading: '<i style="color: white;" class="fa fa-hourglass"></i>',
        callbacks: {
          open: function() {
//             window.setTimeout( function() { document.getElementById('password').focus(); }, 50 );

          },
          close: function(){
//               if( contentUpdated ){ location.reload(); }
          }
        }
    });

    var version = detectIE();
    console.log("browser = "+version);
    if (version) {
//       document.getElementById('price-list').style.position = 'absolute';
        console.log("browser = "+version);
    }

  });

  function compress(objc){
    objc.style.height = '800px';
    objc.contentWindow.document.getElementById('fancybox-content').style.height = '600px';
  }

  function readyFancy(){
      $("a#sample").trigger("click");
  }
  function callMe(site){
//       $("#sample").fancybox({
//           'margin'             : 10,
//           'padding'            : 10,
//           'width'        : '90%',
//           'height'     : '90%',
//           'transitionIn'   : 'none',
//           'transitionOut'    : 'none',
//           'type'       : 'iframe',
//           'href'       : '{{shop.secure_url}}'+site+'',
//           'autoScale'       : true,
//           'onStart'      : function(){$("body").css({'overflow':'hidden'});},
//           'onClosed'     : function(){$("body").css({"overflow":"visible"});},
//           'onComplete' : function(){
//                                         jQuery.fancybox.showActivity();
//                                         jQuery('#fancybox-frame').load(function(){
//                                             jQuery.fancybox.hideActivity();
//                                         });

//                                   }
//       });
  $("#sample").prop('href', '{{shop.secure_url}}'+site+'');
    readyFancy();
  }

  function fancyOn(){
     scrollTop = $(window).scrollTop();
     iframeWin.style.height = window.innerHeight+"px";
     $(window).scrollTop(135);
  }

  function fancyOff(){
     iframeWin.style.height = appFrameHeight;
     $(window).scrollTop(scrollTop);
  }

  function openPage(page){
    var $id = "";
    if(page == 1){
      $id = document.getElementById('link-sales');
      $id.setAttribute("target", "_blank");
      $id.click();
    }
    else if(page == 2){
      $id = document.getElementById('link-food-service');
      $id.setAttribute("target", "_blank");
      $id.click();
    }
    else if(page == 3){
      $id = document.getElementById('link-all-other');
      $id.setAttribute("target", "_blank");
      $id.click();
    }
  }

  function getValue(){
    iframeWin.postMessage({call:'sendValue', value: '{{ settings.color_secondary }}' }, '*');
  }

  console.log('{{customer.id}}');

  function hideHeaderFooter(){
//     $('header, footer').addClass('hide');
    parent.location.assign('{{shop.secure_url}}/account/login');
  }

  function updateCart(){
      $.getJSON(_config.shopifyAjaxCartURL, function(cart) {

          if (_config.cartCountSelector && $(_config.cartCountSelector).size()) {
            var value = $(_config.cartCountSelector).html() || '0';
            $(_config.cartCountSelector).html(value.replace(/[0-9]+/,cart.item_count)).removeClass('hidden-count');
          }
          if (_config.cartTotalSelector && $(_config.cartTotalSelector).size()) {
            if (typeof Currency !== 'undefined' && typeof Currency.moneyFormats !== 'undefined') {
              var newCurrency = '';
              if ($('[name="currencies"]').size()) {
                newCurrency = $('[name="currencies"]').val();
              }
              else if ($('#currencies span.selected').size()) {
                newCurrency = $('#currencies span.selected').attr('data-currency');
              }
              if (newCurrency) {
                $(_config.cartTotalSelector).html('<span class=money>' + Shopify.formatMoney(Currency.convert(cart.total_price, "{{ shop.currency }}", newCurrency), Currency.money_format[newCurrency]) + '</span>');
              }
              else {
                $(_config.cartTotalSelector).html(Shopify.formatMoney(cart.total_price, "{{ shop.money_format | remove: "'" | remove: '"' }}"));
              }
            }
            else {
              $(_config.cartTotalSelector).html(Shopify.formatMoney(cart.total_price, "{{ shop.money_format | remove: "'" | remove: '"' }}"));
            }
          };
        });
  }

  Shopify.formatMoney = function(thePrice, theFormat) {

    var formatPattern = /\{\{\s*(\w+)\s*\}\}/;
    theFormat = (theFormat || this.money_format);

    if (typeof thePrice == 'string') {
        thePrice = thePrice.replace(/[^0-9]/g,'');
        }
    thePrice = parseInt(thePrice);
    thePrice = thePrice.toString();

    switch (thePrice.length) {
        case 0:
        thePrice = '000';
        break;

        case 1:
        thePrice = '00' + thePrice;
        break;

        case 2:
        thePrice = '0' + thePrice;
        break;

        default:
        break;
        }

    var decimalsString = thePrice.substr(thePrice.length - 2);
    var unitsString = thePrice.substr(0, thePrice.length - 2);
    var separator = ',';
    var decimalsSeparator = '.';

    function addSeparator(moneyString, separator) {
        separator = (separator || ',');
        return moneyString.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + separator);
        }

    switch(theFormat.match(formatPattern)[1]) {

        case 'amount_no_decimals':
        decimalsString = '';
        decimalsSeparator = '';
        break;

        case 'amount_with_comma_separator':
        separator = '.';
        decimalsSeparator = ',';
        break;

        case 'amount_no_decimals_with_comma_separator':
        separator = '.';
        decimalsString = '';
        decimalsSeparator = '';
        break;

        default:
        break;

        }

    var output1 = addSeparator(unitsString, separator) + decimalsSeparator + decimalsString;
    var output2 = theFormat.replace(formatPattern, output1);
    return output2;

    }


    function detectIE() {
      var ua = window.navigator.userAgent;

      var msie = ua.indexOf('MSIE ');
      if (msie > 0) {
        return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
      }

      var trident = ua.indexOf('Trident/');
      if (trident > 0) {
        var rv = ua.indexOf('rv:');
        return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
      }
      return false;
    }

</script>
